<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<script src="typed.js"></script>
<link rel="import" href="animations.html">

<dom-module id="cloudstitch-terminal">
  <template>
    <iron-ajax
      id="animations"
      url="https://api.cloudstitch.com/ted/documentation-animations?dev=true"
      on-response="onResponse"
      auto
    ></iron-ajax>
    <style include="animation-styles">
      :host {
        display: block;
        --newX: 100%;
        --newY: 100%;
      }

      .nocursor + .typed-cursor{
        opacity: 0 !important;
      }

      .cli {

      }

      .prompt {
        font-weight: bold;
        margin-right: 10px;
        opacity: 0;
      }

      .prompt, .cmd {
        display: inline-block;
      }

      /* Keyframes for the fade-in */
      @-webkit-keyframes fadeInPrompt { from { opacity:0; } to { opacity:1; } }
      @-moz-keyframes fadeInPrompt { from { opacity:0; } to { opacity:1; } }
      @keyframes fadeInPrompt { from { opacity:0; } to { opacity:1; } }
      .promptAnimation {
        opacity:0;
        opacity: 1 \9; /*just in case ie*/
        -webkit-animation:fadeInPrompt ease-in 1;
        -moz-animation:fadeInPrompt ease-in 1;
        animation:fadeInPrompt ease-in 1;

        -webkit-animation-fill-mode:forwards;
        -moz-animation-fill-mode:forwards;
        animation-fill-mode:forwards;

        -webkit-animation-duration:0.1s;
        -moz-animation-duration:0.1s;
        animation-duration:0.1s;
      }

      #terminal {
        background-color: black;
        border-radius: 5px;
        width: 300px;
        height: 200px;
        color: white;              
      }

      #folder {
        background-color: #ccc;
        border-radius: 5px;
        width: 300px;
        height: 200px;
        color: white;    
      }

      #browser {
        background-color: #ffcc99;
        border-radius: 5px;
        width: 300px;
        height: 200px;
        color: white;              
      }

      #terminalBody {
        font-family: "Roboto Mono";
      }

      .file {
        width: 100px;
        height: 100px;
        background-color: red;
        display: block;
      }

      .title {
        width: 100%;
        text-align: center;
        font-weight: bold;
        color: #555;
      }

      .windowBody {
        padding: 20px;
      }
  
      .hidden {
        display: none;
      }

      .window {
        float: left;
        margin: 20px;
      }

    </style>
    <h2>Hello [[prop1]]!</h2>

    <div id="terminal" class="window">
      <div id="terminalTitle" class="title">Terminal</div>
      <div id="terminalBody" class="windowBody"></div>
    </div>

    <div id="folder" class="window hidden">
      <div id="folderTitle" class="title">Folder</div>
      <div id="folderBody" class="windowBody"></div>
    </div>

    <div id="browser" class="window hidden">
      <div id="browserTitle" class="title">Browser</div>
      <div id="browserBody" class="windowBody">        
      </div>
    </div>

  </template>

  <script>
    // http://stackoverflow.com/questions/2970525/converting-any-string-into-camel-case
    function camelize(str) {
      return str.replace(/(?:^\w|[A-Z]|\b\w)/g, function(letter, index) {
        return index == 0 ? letter.toLowerCase() : letter.toUpperCase();
      }).replace(/\s+/g, '');
    }

    // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    /**
     * `cloudstitch-terminal`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CloudstitchTerminal extends Polymer.Element {
      static get is() { return 'cloudstitch-terminal'; }
      static get properties() {
        return {
          name: {
            type: String,
            value: 'Jekyll'
          }
        };        
      }

      onResponse() {
        console.log(this.$.animations.lastResponse);
        this.name = getParameterByName('name') || 'Jekyll';
        var script = this.$.animations.lastResponse[this.name];
        this.processFrames(script); 
      }

      processFrames(frames, done) {
        var self = this;
        var processAt = function(i) {
          if (i < frames.length) {
            self.processFrame(frames[i], function() {
              processAt(i+1);
            })
          }          
        }
        processAt(0);
      }

      processFrame(frame, done) {   
        var name = camelize(frame.Type);
        if (this[name]) {
          this[name](frame, function() {
            if (frame['End Delay']) {
              setTimeout(function() {
                done();
              }, (frame['End Delay'] * 1000));
            } else {
              done();
            }
          });
        }
      }

      terminalInput(frame, done) {
        var cli = document.createElement('div');
        cli.classList.add('cli');

        var prompt = document.createElement('span');
        prompt.classList.add('prompt');
        prompt.classList.add('promptAnimation');
        prompt.innerHTML = '$ ';
    
        var cmd = document.createElement('span');
        cmd.classList.add('cmd');

        cli.appendChild(prompt);
        cli.appendChild(cmd);

        this.$.terminalBody.appendChild(cli);

        var typed = Typed.new(cmd, {
          strings: [frame.Text],
          typeSpeed: 2,
          startDelay: (0.1 + frame['Start Delay'].delay) * 1000,
          callback: function() {
            cmd.classList.add('nocursor');
            done(typed)
          }
        });
      }

      showFolder(frame, done) {
        this.$.folder.classList.remove('hidden');
        this.$.folder.classList.add('animated');
        this.$.folder.classList.add('slideInUp');    
        this.$.folderTitle.innerHTML = frame.Text || '';
        if (frame.Class) {
          this.$.folder.classList.add(frame.Class);
        }
        done();
      }

      showBrowser(frame, done) {
        this.$.browser.classList.remove('hidden');
        this.$.browser.classList.add('animated');
        this.$.browser.classList.add('slideInUp');
        if (frame.Class) {
          this.$.browser.classList.add(frame.Class);
        }
        this.$.browserTitle.innerHTML = frame.Text || '';
        done();
      }

      updateBrowser(frame, done) {
        var updateRow = document.createElement('div');
        updateRow.classList.add('updateRow');

        var updateText = document.createElement('span');
        updateText.classList.add('updateText');
        updateText.innerHTML = frame.Text

        updateRow.appendChild(updateText);
        this.$.browserBody.appendChild(updateRow);

        done();
      }

      addFile(frame, done) {
        var file = document.createElement('div');
        file.classList.add('file');
        file.classList.add('animated');
        file.classList.add('slideInLeft');

        var fileTitle = document.createElement('span');
        fileTitle.classList.add('fileTitle');
        fileTitle.innerHTML = frame.Text;
        file.appendChild(fileTitle);

        this.$.folderBody.appendChild(file);
        done();
      }

    }

    window.customElements.define(CloudstitchTerminal.is, CloudstitchTerminal);
  </script>
</dom-module>
